<html>
<head>
	<title></title>
	<script type="text/javascript" src="js/jsondiffpatch.js"></script>
	<script type="text/javascript" src="js/sockjs-1.0.3.js"></script>
	<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
	<script type="text/javascript" src="js/hash.js"></script>
</head>
<body>
<button id="test">Send data</button>
<script>
var testData = {},
	sock = new SockJS('http://localhost:9999/dataPortal');

sock.onopen = function() {
	console.log('open');
};

sock.onmessage = function(e){
	var message = JSON.parse(e.data);
	console.log('message', message, message.type);
	if(message.type == "data") {
		testData = message.data;
	} else if(message.type == "diff") {
		//	Conditionally patch the data
		if(hash(testData) !== message.hash) {
			console.log("patch diff", message.diff);
			jsondiffpatch.patch(testData, message.diff);
		} else {
			console.log("hash already matches, no patch");
		}
	}
};

sock.onclose = function() {
	console.log('close');
};

//	Click the test button to see the magic
$('#test').click(function(){
	//	Clone object and add something
	var newTestData = {};
	jsondiffpatch.patch(newTestData, jsondiffpatch.diff({}, testData));
	newTestData.c = {f:"minor"};
	var delta = jsondiffpatch.diff(testData, newTestData);
	//	Patch it, so only other clients need to patch
	testData = newTestData;
	//	Send it
	sock.send(JSON.stringify({
		diff: delta,
		hash: hash(newTestData)
	}));
});
</script>

</body>
</html>