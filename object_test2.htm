<html>
<head>
	<title></title>
	<script type="text/javascript" src="js/jsondiffpatch.js"></script>
	<script type="text/javascript" src="js/sockjs-1.0.3.js"></script>
	<script type="text/javascript" src="js/jquery-1.11.3.js"></script>
	<script type="text/javascript" src="js/hash.js"></script>
	<script type="text/javascript" src="js/knockout-3.3.0.js"></script>
</head>
<body>

<script>

var DataPortal = function (value, options) {
	options = options || {};
	var self = function(val){
			if(typeof val !== "undefined") {
				return self.set(val);
			}
			return self.get();

		},
		subs = [],
		value,
		prevValue,
		//	Send notifications to subscribers
		notify = function (value, prevValue) {
			var i;
			for (i = 0; i < subs.length; i += 1) {
				subs[i].func.apply(subs[i].context, [value, prevValue]);
			}
		};

	//  Set a value - trigger notifications
	//  Will only trigger when the value has actually changed - this prevents infinite loops
	self.set = function (val) {
		value = val;
		if (prevValue !== value) {
			notify(value, prevValue);
			prevValue = value;
		}
	};

	self.trigger = function (val) {
		notify((val !== undefined) ? val : value);
	};

	self.get = function () {
		return value;
	};

	self.subscribe = function (func, context) {
		subs.push({ func: func, context: context || self });
	};

	self.set(value);

	//	
	return self;
	// function(val){
	// 	if(typeof val !== "undefined") {
	// 		return self.set(val);
	// 	}
	// 	return self.get();
	// }
};

var obj = new DataPortal({hello: "world"});

obj.subscribe(function(value, prevValue){
	console.log('value', value, prevValue, jsondiffpatch.diff(prevValue, value));
});

//console.log(obj());

obj({hello: "world", gday: "universe"});

//console.log(obj());



</script>


<script>
//https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty



// Example of an object property added with defineProperty with an accessor property descriptor
/*
var bValue = 38, o = {};
Object.defineProperty(o, 'b', {
  get: function() { console.log('get'); return bValue; },
  set: function(newValue) { console.log('set', newValue); bValue = newValue; },
  enumerable: true,
  configurable: true
});
console.log(o.b); // 38
o.b = 39;
console.log(o.b); // 38
*/
</script>




<script>

/*
	Idea: setup getter/setter watchers on the object, and use them to 
	transport the data diffs.

	Note: may not be super perfomant with large objects.

	Ref: http://stackoverflow.com/a/722732
*/
//your object
var o = {
		foo:"bar",
		arr:[1,2,3],
		sub: {
			foo2: "bar2",
			bar: {
				"susanne": "scary",
				"kids": [1,2,3,{"wtf": true}]
			}
		}
	}, 
	newObj = {};

//	Ref: http://bonsaiden.github.io/JavaScript-Garden/#types
var getType = function(obj) {
	return Object.prototype.toString.call(obj).slice(8, -1);
}

var defProp = function(obj, prop, value, descriptor) {
	var propValue;

	descriptor = descriptor || {};
	
	descriptor.get = descriptor.get || function() {
		console.log('get', prop);
		return propValue; 
	};
	
	descriptor.set = descriptor.set || function(newValue) {
		console.log('set', prop, newValue);
		propValue = newValue; 
	};

	descriptor.enumerable = typeof descriptor.enumerable !== "undefined"? descriptor.enumerable: true;
	
	descriptor.configurable = typeof descriptor.configurable !== "undefined"? descriptor.configurable: true;

	console.log('define', obj, prop);

	Object.defineProperty(obj, prop, descriptor);
};

//called with every property and it's value
function process(key, value, newObj) {
	//var oType;
	console.log('process', key + " : "+value, 'newObj', newObj);
	if(typeof key !== "undefined"){
		//oType = getType(value);

		console.log('set', key, value, newObj);
		newObj = value;
	}
}

function copyOf(value) {
	var oType = getType(value);
	if(oType !== "Undefined" ) {
		if(oType == "Array" ) {
			return value.slice();
		} else if(oType !== "Object" ) {
			return JSON.parse(JSON.stringify(value));
		} else if(oType !== "String" ) {
			return "" + value;
		} else {
			return 0 + value;
		}

	} else {
		return undefined;
	}
}

function traverse(oldObj, process, newObj) {
	var oType;
	for (var i in oldObj) { if(oldObj.hasOwnProperty(i)){
		oType = getType(oldObj[i]);
		//if (oType == "Object" || oType == "Array") {
			//	Define new property
		defProp(newObj, i, oldObj[i]);

		//}
		//process.apply(this,[i,oldObj[i],newObj[i]]);  

		//	ISSUE: This passes by reference, duh.
		//newObj[i] = oldObj[i];
		console.log('SET', i, copyOf(oldObj[i]), newObj[i]);

		if (oType == "Object") {
			console.log("----------------- object", i, newObj[i]);

			traverse(oldObj[i], process, newObj[i]);
		}
		
	}}
}


console.log('before', JSON.stringify(o));

//that's all... no magic, no bloated framework
traverse(o, process, newObj);

console.log('after oldobj', JSON.stringify(o));
console.log('after', JSON.stringify(newObj));

</script>



<!--


<button id="subscribe">Subscribe to myObject</button>
<button id="publish">Publish changed data</button>


<script>
//	NOTE: We can only have 1 connection to sockjs
var sock = new SockJS('http://localhost:9999/dataPortal');

/*
sock.onopen = function() {



	myPortal = new DataPortal("myObject", myObject);
	//	Update myObject
	myObject.something = "a thing";
	//	Let the portal know
	myPortal.publish(myObject);



};
*/
// sock.onmessage = function(e){
// 	var message = JSON.parse(e.data);
// 	if(message.type == "data") {
// 		//testData = message.data;
// 		console.log("got data", message);
// 	} else if(message.type == "diff") {
// 		console.log("got diff", message);
// 		//	Conditionally patch the data
			
// 		if(hash(testData) !== message.hash) {
// 			console.log("patch diff", message.diff);
// 			jsondiffpatch.patch(testData, message.diff);
// 		} else {
// 			console.log("hash already matches, no patch");
// 		}
		
// 	}

// 	//	Update log with data
// 	//$('#log').val(JSON.stringify(testData));
// };
/*
sock.onclose = function() {
	console.log('close');
};
*/
</script>

<script>


/*
	We need a data portal factoy that knows when the socket is ready, and can call the 'ready' methods on each data portal.

*/
(function(win, sock){
	var portals = [],
		subscriptions = {},
		getSubscribedPortals = function(topic){
			return subscriptions[topic] || [];
		},
		isReady = false,
		//	ref: http://stackoverflow.com/a/2117523
		guid = function() {
			return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
				var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
				return v.toString(16);
			});
		};

	//	Name is optional - it must be specified if you want to share the object with other browsers, so they can subscribe to it.
	//	The name will be generated if not specified, and you can have reactive data that the server can modify, and you can get the changes automatically.
	var DataPortal = function(obj, name){

		name = name || guid();

		var self = this,
			objectValue = obj,
			originalObj = JSON.parse(JSON.stringify(obj)),
			readyFunctions = [],
			value = function(newObj){
				if(typeof newObj !== "undefined") {
					objectValue = newObj;
				}
				return objectValue;
			},
			publish = function(newObj){
				var delta = jsondiffpatch.diff(originalObj, newObj);
				//	Send it
				sock.send(JSON.stringify({
					type: "publish",
					topic: name,
					message: {
						diff: delta,
						hash: hash(newObj)
					}
				}));
			},
			//	Subscribe to messages
			//	TODO: cache the last message, so we can always 
			//	give new subscribers the JSON object.
			subscribe = function(topic){
				console.log("subscribe", topic);

				//	Do it locally
				subscriptions[topic] = subscriptions[topic] || [];
				subscriptions[topic].push(self);

				//	Send it
				sock.send(JSON.stringify({
					type: "subscribe",
					topic: topic
				}));
			},
			//	When the socket is ready
			ready = function(cb){
				if(isReady) {
					cb(self);
				} else {
					readyFunctions.push({cb: cb, self: self});
				}
			};

		//	Always publish when created
		//publish(obj);

		//	Allow pub/sub
		return {
			value: value,
			publish: publish,
			subscribe: subscribe,
			ready: ready,
			readyFunctions: readyFunctions
		};
	};

	//	Handle sock open
	sock.onopen = function() {
		console.log('sock open');
		isReady = true;

		//	Loop on portals and call each ready method
		for(var i = 0; i < portals.length; i += 1) {
			console.log('ready', portals[i]);
			for(var j = 0; j < portals[i].readyFunctions.length; j += 1){
				portals[i].readyFunctions[j].cb(portals[i].readyFunctions[j].self);
			}
		}
	};


	//	Handle messages
	//	Note: the server holds the subscriptions, so assume that we only get messages that we care about.
	sock.onmessage = function(e){
		var message = JSON.parse(e.data);
		if(message.type == "data") {
			console.log("got data", message);
			var subs = getSubscribedPortals(message.topic), i;
			console.log(message.topic, 'data subs', subs);
			//	Set the data
			for(i = 0; i < subs.length; i += 1) {
				subs[i].value(message.data);
			}
		} else if(message.type == "diff") {
			console.log("got diff", message);
			//	Conditionally patch the data
			/*	
			if(hash(testData) !== message.hash) {
				console.log("patch diff", message.diff);
				jsondiffpatch.patch(testData, message.diff);
			} else {
				console.log("hash already matches, no patch");
			}
			*/

			var subs = getSubscribedPortals(message.topic), i;
			console.log(message.topic, 'diff subs', subs);

			//	Set the data
			for(i = 0; i < subs.length; i += 1) {
				if(hash(subs[i].value()) !== message.hash) {
					console.log("patch diff", message.diff);
					jsondiffpatch.patch(testData, message.diff);
				} else {
					console.log("hash already matches, no patch");
				}
			}


		} else {
			console.log("unrecognised message", message);
		}

		//	Update log with data
		//$('#log').val(JSON.stringify(testData));
	};

	sock.onclose = function() {
		console.log('close');
	};

	win.DataPortalFactory = function(object, name){
		var myPortal = new DataPortal(object, name);
		portals.push(myPortal);
		return myPortal;
	};

}(window, sock));

</script>

<script>
var myObject = {
		thisis: "an object"
	},
	mp = DataPortalFactory(myObject, 'myObject');

mp.ready(function(portal){
	console.log('portal ready', portal);
	//	Subscribe to and update our object
	mp.subscribe("myObject");
	myObject.c = {f:"minor"};
	mp.publish(myObject);
});

</script>


<script>
/*
var myPortal,
	myObject = {
		thisis: "an object"
	};

$('#subscribe').click(function(){
	myPortal.subscribe("myObject");
});

$('#publish').click(function(){
	myObject.c = {f:"minor"};
	myPortal.publish(myObject);
});
*/
</script>

-->

</body>
</html>